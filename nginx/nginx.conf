# /nginx/nginx.conf
# Optimized Nginx configuration for Flask app with static file serving
    # Upstream backend (Flask application)

upstream flask_backend {
        server flask-app:5000;
}

server {
    listen 80;
    server_name _;


    # ============================================================================
    # STATIC FILES LOCATION BLOCK
    # Serve static assets (CSS, JavaScript, images, fonts) directly from Nginx
    # This bypasses Flask entirely for better performance
    # ============================================================================
    location /static/ {
        # Serve files from the static directory mounted in the container
        # The path must match the volume mount in docker-compose.yml
        alias /app/static/;
        autoindex on;
        # Only allow GET and HEAD requests for static files
        limit_except GET HEAD {
            deny all;
        }
        
        # Cache static assets in browser for 30 days
        # This reduces bandwidth and improves repeat visitor performance
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Log access to static files (optional, can be disabled for cleaner logs)
        access_log off;
        
        # If a file doesn't exist, return 404 (don't pass to Flask)
        error_page 404 = @not_found;
    }

    # ============================================================================
    # OPTIMIZED STATIC FILE EXTENSIONS (Alternative approach)
    # You can also use regex to match specific file types
    # This is useful if static files aren't in a /static/ directory
    # ============================================================================
    # Uncomment this block if your static files have extensions like .css, .js, etc
    # But are served from different locations or have no consistent /static/ prefix
    location ~ \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /app/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ============================================================================
    # HEALTH CHECK ENDPOINT (Optional)
    # If your Flask app has a /health endpoint, you can serve it efficiently
    # ============================================================================
    location /health {
        proxy_pass http://flask_backend;
        access_log off;
    }
    location /movies{
        proxy_pass http://flask_backend;
        access_log off;
    }
    # ============================================================================
    # DEFAULT LOCATION BLOCK
    # Pass all other requests to the Flask application
    # ============================================================================
    location / {
        # Proxy pass requests to Flask backend
        proxy_pass http://flask_backend;
        
        # Set important headers for the backend to know about the original request
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts to prevent hanging connections
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================================================
    # ERROR PAGE FOR MISSING STATIC FILES
    # ============================================================================
    location @not_found {
        # Return 404 without proxying to Flask
        # This keeps static file 404s fast and doesn't burden the backend
        return 404;
    }

    # ============================================================================
    # DENY ACCESS TO SENSITIVE FILES
    # Prevent accidental exposure of config files, database, etc.
    # ============================================================================
    location ~ /\. {
        # Deny access to hidden files and directories (starting with .)
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ ~$ {
        # Deny access to backup files
        deny all;
        access_log off;
        log_not_found off;
    }
}
