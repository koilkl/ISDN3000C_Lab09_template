<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Let's add some minimal styling -->
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 1em; }
        h1 { color: #333; }
    </style>
    <title>{{ page_title }}</title>
</head>



<body>
    <h1>Welcome to the Guestbook!</h1>
    <hr>
    <form method="post">
        <label for="name">Name:</label><br>
        <input type="text" name="name" placeholder="Your name" required><br><br>

        <label for="message">Message:</label><br>
        <textarea name="message" placeholder="Your message" rows="3" cols="40" required></textarea><br><br>

        <button type="submit">Post Message</button>
    
     </form>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <ul class=flashes>
    {% for message in messages %}
      <small>{{ message }}</small>
       {% else %}
        <li>No messages yet!</li>
    {% endfor %}
    </ul>
    {% endif %}   
    {% endwith %}
   
    <hr />

    <p>Here are the current entries:</p>
    <ul>
    {% for message in messages %}
        <strong>{{ message['name'] }}</strong> 
        <small>({{ message['created_at'] }})</small>:
        <br>
            {{ message['message'] }}
        <br>
        {% else %}
        <li>No messages yet!</li>
    {% endfor %}
    </ul>

    
    
    <script>
    // Select the form
    const form = document.querySelector('form');
    // Add an event listener for the 'submit' event
    form.addEventListener('submit', async (event) => {
        // Prevent the default page reload
        event.preventDefault();

        // Get the form data
        const formData = new FormData(form);
        const name = formData.get('name');
        const message = formData.get('message');
        if (!name || !message) {
            alert('Please fill in both fields.');
            return;
        }
        if(message.length > 140||name.length > 140)
        {
            alert('Message is too long. Please limit to 140 characters.');
            return;
        }
        
        // Send the data to our new API endpoint
        try {
            const response = await fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, message }),
            });

            const result = await response.json();

            if (response.ok) {
                // If successful, clear the input fields so user can write another message
                alert('Message posted successfully!');
                form.querySelector('input[name="name"]').value = '';
                form.querySelector('textarea[name="message"]').value = '';
                // Optionally, set focus back to name field
                form.querySelector('input[name="name"]').focus();
                //location.reload(); // Reload the page to show the new message
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Submission failed:', error);
            alert('An error occurred. Please try again.');
        }
    });
</script>
</body>
</html>